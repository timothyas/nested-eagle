defaults:
- data: zarr
- dataloader: native_grid
- diagnostics: evaluation_ens
- system: slurm
- graph: encoder_decoder_only
- model: transformer_ens
- training: stretched_ensemble
- _self_

config_validation: True

data:
  datasets:
    data:
      forcing:
        - cos_latitude
        - sin_latitude
        - cos_longitude
        - sin_longitude
        - cos_julian_day
        - sin_julian_day
        - cos_local_time
        - sin_local_time
        - insolation
        - lsm
        - orog
      diagnostic:
        - accum_tp
        - u80
        - v80
      processors:
        normalizer:
          _target_: anemoi.models.preprocessing.normalizer.InputNormalizer
          config:
            default: mean-std
            std:
              - accum_tp
              - sh2
              - q_100
              - q_150
              - q_200
              - q_250
              - q_300
              - q_400
              - q_500
              - q_600
              - q_700
              - q_850
              - q_925
              - q_1000
            max:
              - orog
            none:
              - cos_latitude
              - sin_latitude
              - cos_longitude
              - sin_longitude
              - cos_julian_day
              - sin_julian_day
              - cos_local_time
              - sin_local_time
              - insolation
              - lsm

dataloader:
  prefetch_factor: 2
  batch_size:
    training: 1
    validation: 1
    test: 1
  num_workers:
    training: 8
    validation: 8
    test: 1
  limit_batches:
    training: null
    validation: null
    test: 1
  dataset:
    cutout:
      # LAM
      - dataset: ${system.input.lam_dataset}
        trim_edge: [10, 11, 10, 11]
      # Global forcing
      - dataset: ${system.input.global_dataset}
    adjust: all
    min_distance_km: 15
  training:
    datasets:
      data:
        start: 2015-02-01
        end: 2023-01-31
  validation:
    datasets:
      data:
        start: 2023-02-01
        end: 2024-01-31
  test:
    datasets:
      data:
        start: 2023-02-01
        end: 2024-01-31

diagnostics:
  log:
    wandb:
      enabled: False
      entity: null
    mlflow:
      enabled: True
      offline: True
      log_model: False
      tracking_uri: null
      experiment_name: '1.00deg-15km crps06h training-steps'
      project_name: 'Nested-EAGLE'
      system: True
      terminal: True
      run_name: null # If set to null, the run name will be the a random UUID
      on_resume_create_child: True
      expand_hyperparams: # Which keys in hyperparams to expand
        - config
      http_max_retries: 35
  plot:
    frequency:
      batch: 300_000
      epoch: 500
    parameters: []
    precip_and_related_fields: []
    callbacks: []
  callbacks: []

graph:
  overwrite: False
  nodes:
    data:
      node_builder:
        _target_: anemoi.graphs.nodes.AnemoiDatasetNodes
        dataset: ${dataloader.dataset}
      attributes: ${graph.attributes.nodes}
    hidden:
      node_builder:
        _target_: anemoi.graphs.nodes.NPZFileNodes
        npz_file: ${system.input.latent_mesh}
        lat_key: lat
        lon_key: lon
  edges:
  # Encoder
  - source_name: ${graph.data}
    target_name: ${graph.hidden}
    edge_builders:
    - _target_: anemoi.graphs.edges.KNNEdges
      num_nearest_neighbours: 12
      source_mask_attr_name: null
      target_mask_attr_name: null
    attributes: ${graph.attributes.edges}
  # Decoder
  - source_name: ${graph.hidden}
    target_name: ${graph.data}
    edge_builders:
    - _target_: anemoi.graphs.edges.KNNEdges
      num_nearest_neighbours: 3
      source_mask_attr_name: null
      target_mask_attr_name: null
    attributes: ${graph.attributes.edges}
  attributes:
    nodes:
      # Attributes for data nodes
      cutout_mask:
        _target_: anemoi.graphs.nodes.attributes.CutOutMask
      boundary_mask:
        _target_: anemoi.graphs.nodes.attributes.BooleanNot
        masks:
          _target_: anemoi.graphs.nodes.attributes.CutOutMask
      area_weight:
        _target_: anemoi.graphs.nodes.attributes.SphericalAreaWeights
        norm: unit-max
        fill_value: 0
      lam_area_weight:
        _target_: anemoi.graphs.nodes.attributes.MaskedPlanarAreaWeights
        mask_node_attr_name: cutout_mask
        norm: unit-max
    edges:
      edge_length:
        _target_: anemoi.graphs.edges.attributes.EdgeLength
        norm: unit-max
      edge_dirs:
        _target_: anemoi.graphs.edges.attributes.EdgeDirection
        norm: unit-std

system:
  hardware:
    num_gpus_per_model: 1
    num_gpus_per_ensemble: 2
  input:
    lam_dataset: ${oc.decode:${oc.env:SCRATCH}}/nested-eagle/1.00deg-15km/data/hrrr.zarr
    global_dataset: ${oc.decode:${oc.env:SCRATCH}}/nested-eagle/1.00deg-15km/data/gfs.zarr
    graph: ${oc.decode:${oc.env:SCRATCH}}/nested-eagle/1.00deg-15km/mesh-gen/csmswt-trim10/graph.latentx2.spongex1.12knn.pt
    latent_mesh: ${oc.decode:${oc.env:SCRATCH}}/nested-eagle/1.00deg-15km/mesh-gen/csmswt-trim10/latentx2.spongex1.combined.sorted.npz
    truncation: null
    truncation_inv: null

  output:
    root: ${oc.decode:${oc.env:SCRATCH}}/nested-eagle/1.00deg-15km/crps06h/experiments/training-steps/steps120k/

model:
  compile: []
  num_channels: 512
  noise_conditioned_modules:
    - encoder
    - processor
    - decoder
  noise_injector:
    _target_: anemoi.models.layers.ensemble.MLPNoiseConditioning
    noise_std: 1
    noise_channels_dim: 32
    noise_mlp_hidden_dim: 128
    layer_kernels:
      Linear:
        _target_: torch.nn.Linear
      Activation:
        _target_: torch.nn.GELU
  layer_kernels:
    LayerNorm:
      _target_: anemoi.models.layers.normalization.ConditionalLayerNorm
      condition_shape: 128
      zero_init: True
      autocast: false
    Linear:
      _target_: torch.nn.Linear
    Activation:
      _target_: torch.nn.GELU
    QueryNorm:
      _target_: anemoi.models.layers.normalization.ConditionalLayerNorm
      condition_shape: 128
      zero_init: true
      autocast: true
      learn_bias: false
    KeyNorm:
      _target_: anemoi.models.layers.normalization.ConditionalLayerNorm
      condition_shape: 128
      zero_init: true
      autocast: true
      learn_bias: false
  processor:
    window_size: 4320
  encoder:
    qk_norm: true
  decoder:
    qk_norm: true
  residual:
    _target_: anemoi.models.layers.residual.SkipConnection
    step: -1
  bounding:
    - _target_: anemoi.models.layers.bounding.ReluBounding #[0, infinity)
      variables:
      - accum_tp
      - sh2
      - q_100
      - q_150
      - q_200
      - q_250
      - q_300
      - q_400
      - q_500
      - q_600
      - q_700
      - q_850
      - q_925
      - q_1000

training:
  multistep_input: 1
  ensemble_size_per_device: 1
  max_steps: 120_000
  # LR = local_rate * num_gpus_per_node * num_nodes / gpus_per_model
  #    = local_rate * total_gpus / gpus_per_model
  optimizer:
    _target_: torch.optim.AdamW
    betas: [0.9, 0.95]
    weight_decay: 0.1
  lr:
    warmup: 1000
    rate: 2.5e-4
    iterations: ${training.max_steps}
    min: 3e-7
  variable_groups:
    datasets:
      data:
        default: sfc
        pl:
          param: [gh, u, v, w, t, q]
  metrics:
    datasets:
      data:
        - gh_500
        - t_850
        - u_850
        - v_850
  training_loss:
    datasets:
      data:
        _target_: anemoi.training.losses.kcrps.AlmostFairKernelCRPS
        scalers: ["general_variable", "nan_mask_weights", "node_weights"]
        ignore_nans: False
        alpha: 0.95
        no_autocast: True
  validation_metrics:
    datasets:
      data:
        fkcrps:
          _target_: anemoi.training.losses.kcrps.AlmostFairKernelCRPS
          scalers: ["node_weights"]
          ignore_nans: True
          alpha: 0.95
          no_autocast: True
  scalers:
    datasets:
      data:
        general_variable:
          _target_: anemoi.training.losses.scalers.GeneralVariableLossScaler
          weights:
            default: 1
            q: 0.6
            t: 6
            u: 0.8
            v: 0.5
            w: 0.001
            gh: 12
            sp: 10
            u10: 0.1
            v10: 0.1
            accum_tp: 0.1
        node_weights:
          weight_frac_of_total: 0.1
